<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->  <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
  <title>Running Legacy CGIs with Plack</title>
	
  <meta name="description" content="Methods to convert CGI applications to PSGI">
  <meta name="author" content="Clay Fouts">
  <meta name="viewport" content="width=1024, user-scalable=no">
	
  <!-- Core and extension CSS files -->
  <link rel="stylesheet" href="../core/deck.core.css">
  <link rel="stylesheet" href="../extensions/goto/deck.goto.css">
  <link rel="stylesheet" href="../extensions/menu/deck.menu.css">
  <link rel="stylesheet" href="../extensions/navigation/deck.navigation.css">
  <link rel="stylesheet" href="../extensions/status/deck.status.css">
  <link rel="stylesheet" href="../extensions/hash/deck.hash.css">
	
  <!-- Style theme. More available in /themes/style/ or create your own. -->
  <link rel="stylesheet" href="../themes/style/web-2.0.css">
	
  <!-- Transition theme. More available in /themes/transition/ or create your own. -->
  <link rel="stylesheet" href="../themes/transition/horizontal-slide.css">

  <script src="../modernizr.custom.js"></script>
</head>

<body class="deck-container">

<!-- Begin slides -->
<section class="slide" id="title-slide">
  <h1>Converting from CGI to PSGI</h1>
</section>

<section class="slide" id="why-would-i">
  <h2>Why would I want to do that?</h2>
  <ul>
    <li class="slide">
      <h3>Enables use of thinner webservers</h3>
      <p>Nginx does not support CGI natively.</p>
    </li>
    <li class="slide">
      <h3>Combine applications</h3>
      <p>Tie legacy applications together or combine with PSGI apps.</p>
    </li>
    <li class="slide">
      <h3>Apply Middleware</h3>
      <p>Take advantage of the growing library of Plack::Middleware components.</p>
    </li>
    <li class="slide">
      <h3>Speed!</h3>
      <p>Pay startup penalty only once rather than upon each request.</p>
    </li>
  </ul>
</section>

<section class="slide" id="pieces">
  <h2>Pieces of the puzzle</h2>
  <ul>
    <li>
      <h3>CGI::Compile</h3>
    </li>
  </ul>
</section>

<section class="slide" id="cgi-compile">
  <h2>CGI::Compile</h2>
  <p>Loads contents of a Perl script into an eval()ed subroutine. Hand it a filename; get back a coderef.</p>
  <p><code><pre>
my $cgi = CGI::Compile-&gt;compile('./my-script.pl');<br/>
$cgi-&gt;();
</pre></code></p>
</section>

<section class="slide" id="pieces2">
  <h2>Pieces of the puzzle</h2>
  <ul>
    <li>
      <h3>CGI::Compile</h3>
    </li>
    <li>
      <h3>CGI::Emulate::PSGI</h3>
    </li>
  </ul>
</section>

<section class="slide" id="cgi-emulate-psgi">
  <h2>CGI::Emulate::PSGI</h2>
  <p>Converts the PSGI input environment ($env) into a CGI-compliant one (%ENV, &lt;STDIN&gt;, etc.). Hand it a coderef; get back a PSGI app.</p>
  <p><code><pre>
my $cgi = CGI::Compile-&gt;compile('./my-script.pl');
my $app = CGI::Emulate::PSGI-&gt;handler($cgi);
builder {
    mount '/' => $app;
};
</pre></code></p>
</section>

<section class="slide" id="pieces3">
  <h2>Pieces of the puzzle</h2>
  <ul>
    <li>
      <h3>CGI::Compile</h3>
    </li>
    <li>
      <h3>CGI::Emulate::PSGI</h3>
    </li>
    <li>
      <h3>Plack::App::WrapCGI</h3>
    </li>
  </ul>
</section>

<section class="slide" id="plack-app-wrapcgi">
  <h2>Plack::App::WrapCGI</h2>
  <p>Principally a convenience function to combine CGI::Compile and CGI::Emulate::PSGI.</p>
  <p><code><pre>
my $app = Plack::App::WrapCGI-&gt;new(script =&gt; './my-script.pl')-&gt;to_app;
builder {
    mount '/' =&gt; $app;
};
</pre></code></p>
</section>

<section class="slide" id="pieces4">
  <h2>Pieces of the puzzle</h2>
  <ul>
    <li>
      <h3>CGI::Compile</h3>
    </li>
    <li>
      <h3>CGI::Emulate::PSGI</h3>
    </li>
    <li>
      <h3>Plack::App::WrapCGI</h3>
    </li>
    <li>
      <h3>Plack::App::CGIBin</h3>
    </li>
  </ul>
</section>

<section class="slide" id="plack-app-cgibin">
  <h2>Plack::App::CGIBin</h2>
  <p>Automatically route requests to a whole directory tree of CGI scripts.</p>
  <p><code><pre>
my $app = Plack::App::CGIBin-&gt;new(root =&gt; './cgi-scripts/')-&gt;to_app;
builder {
    mount '/cgi-bin/' =&gt; $app;
};
</pre></code></p>
</section>

<section class="slide" id="caveats">
  <h1>What could go wrong?</h1>
</section>

<section class="slide" id="variable-scope">
  <h2>Variable Scope</h2>
  <p>CGI::Compile turns script contents into a dynamically named package. This changes the scope. Globals declared with "my" in compiled scripts will not be accessible to subroutines declared in the same. Must use "our" to declare them (or pass in as a parameter, of course).</p>
  <p><code><pre>
#!/usr/bin/env perl

my $query = CGI-&gt;new();

sub get_foo {
    return $query-&gt;param('foo');
}

...
</pre></code></p>
</section>

<section class="slide" id="variable-mutation">
  <h2>Variable Mutation</h2>
  <p>The value of package global variables brought in through use/require will maintain state between invocations. This is probably not what you want if the application mutates them.</p>
  <p><code><pre>
package Canned::Pizza;

our $user;

sub initialize {
    my $query = shift;
    $user //= $query-&gt;param('userid');
}

1;
</pre></code></p>
</section>

<section class="slide" id="variable-mutation">
  <h1>Fin</h1>
</section>

<!-- deck.navigation snippet -->
<a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
<a href="#" class="deck-next-link" title="Next">&#8594;</a>

<!-- deck.status snippet -->
<p class="deck-status">
  <span class="deck-status-current"></span>
  /
  <span class="deck-status-total"></span>
</p>

<!-- deck.goto snippet -->
<form action="." method="get" class="goto-form">
  <label for="goto-slide">Go to slide:</label>
  <input type="text" name="slidenum" id="goto-slide" list="goto-datalist">
  <datalist id="goto-datalist"></datalist>
  <input type="submit" value="Go">
</form>

<!-- deck.hash snippet -->
<a href="." title="Permalink to this slide" class="deck-permalink">#</a>


<!-- Grab CDN jQuery, with a protocol relative URL; fall back to local if offline -->
<script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.min.js"></script>
<script>window.jQuery || document.write('<script src="../jquery-1.7.min.js"><\/script>')</script>

<!-- Deck Core and extensions -->
<script src="../core/deck.core.js"></script>
<script src="../extensions/hash/deck.hash.js"></script>
<script src="../extensions/menu/deck.menu.js"></script>
<script src="../extensions/goto/deck.goto.js"></script>
<script src="../extensions/status/deck.status.js"></script>
<script src="../extensions/navigation/deck.navigation.js"></script>

<!-- Initialize the deck -->
<script>
$(function() {
	$.deck('.slide');
});
</script>

</body>
</html>
